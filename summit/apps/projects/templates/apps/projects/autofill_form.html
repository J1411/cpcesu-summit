{% extends 'base.html' %}
{% load static %}

{% block primary %}
<div class="card">
  <div class="card-header">
      <h3>Autofill</h3>
  </div>
  <div class="card-body">
    <h5 class="card-title">Please fill out all fields.</h5>

        <form class="form-horizontal" action="" id="autofill-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.non_field_errors }}
            {% include 'apps/projects/form-template.html'%}
            <input class="btn btn-primary" type="submit" value="Submit">
        </form>

      <p>
  The Task is <span id="user-count"></span>!
</p>
<div class="status"></div>
   {% if task_id %}
   <div class="progress">
       <div class="bar"></div>
   </div>

{% endif %}
</div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script type="text/javascript">
   var poll_xhr;
   var willstop = 0;
  (function(){
    var poll = function(){
      var json_dump = "{{ data }}";
      var task_id = "{{task_id}}";
      console.log(task_id);
      poll_xhr = $.ajax({
        url:'poll_state',
        type: 'POST',
        data: {
            task_id: task_id,
            csrfmiddlewaretoken: "{{csrf_token}}",
        },
        success: function(result) {
                    if (result.process_percent == null || result.process_percent == undefined) {
                        willstop = 1;
                        document.getElementById("user-count").textContent="DONE";
                        jQuery('.bar').css({'width': 100 + '%'});
                        jQuery('.bar').html(100 + '%');
                        //document.getElementById('returnBtn').style.visibility = 'visible';
                       } else {
                         jQuery('.bar').css({'width': result.process_percent + '%'});
                         jQuery('.bar').html(result.process_percent + '%');
                         document.getElementById("user-count").textContent="PROCRESSING";
                       };
                    }
      });
    };
    var refreshIntervalId = setInterval(function() {
      poll();
      if(willstop == 1){
        clearInterval(refreshIntervalId);
      }
    },500);
  })();

</script>
{% endblock %}
<!--<script src="static/js/site.js"></script>-->


